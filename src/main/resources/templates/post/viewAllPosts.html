<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>All Posts</title>
</head>
<body>
<div class="containers">
    <div>
        <table id="postsTable" style="border-collapse: collapse;">
            <thead>
            <tr>
                <th style="border-left: none;">#</th>
                <th style="border-left: 1px solid black;">제목</th>
                <th style="border-left: 1px solid black;">본문</th>
                <th style="border-left: 1px solid black;">업로드 일자</th>
                <th style="border-left: 1px solid black;">업로드 시각</th>
                <th style="border-left: 1px solid black;">수정 시각</th>
            </tr>
            </thead>
            <tbody>
            <!-- 여기에 데이터가 삽입됩니다 -->
            </tbody>
        </table>
    </div>
</div>
<script>
    //delete 요청을 보내는 함수
    async function deletePost(id) {
        const response = await fetch(`/api/posts/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            alert('삭제되었습니다.');
            location.reload();
        } else {
            alert('삭제 실패');
        }
    }

    // 페이지 로딩이 완료되면 실행
    window.addEventListener('load', async () => {
        // API로부터 데이터 가져오기
        const response = await fetch('/api/posts/all');
        const posts = await response.json();

        // 테이블에 행 추가
        const table = document.getElementById('postsTable');
        posts.forEach((post, index) => {
            const row = table.insertRow(-1); // 마지막에 행 추가
            let cell;

            //id
            cell = row.insertCell(0);
            cell.innerHTML = post.post_id;
            cell.style.textAlign = "center";

            //제목
            cell = row.insertCell(1);
            cell.innerHTML = post.post_title;
            cell.style.textAlign = "center";

            //본문 첫줄
            cell = row.insertCell(2);
            cell.innerHTML = post.contents.split('\n')[0]; // 첫 줄만 추출
            cell.style.textAlign = "center";

            //생성일
            cell = row.insertCell(3);
            cell.innerHTML = new Date(post.create_at).toLocaleDateString();
            cell.style.textAlign = "center";

            //생성시각
            cell = row.insertCell(4);
            cell.innerHTML = new Date(post.create_at).toLocaleTimeString();
            cell.style.textAlign = "center";

            // 수정시각 출력용 함수
            const createDate = new Date(post.create_at);
            const lastModified = new Date(post.last_modified);

            const createDateString = createDate.toDateString();  // "Wed Dec 09 2020"
            const lastModifiedString = lastModified.toDateString(); // "Wed Dec 09 2020"

            let displayString = "";
            if (createDate.getTime() === lastModified.getTime()) {
                displayString = "-";
            } else if (createDateString === lastModifiedString) {
                displayString = new Date(post.last_modified).toLocaleTimeString();
            } else {
                displayString = new Date(post.last_modified).toLocaleDateString();
            }


            //수정 일시
            cell = row.insertCell(5);
            cell.innerHTML = displayString;
            cell.style.textAlign = "center";

            //게시글 보기
            cell = row.insertCell(6);
            cell.innerHTML = `<a href="/posts/view/${post.post_id}">보기</a>`;
            cell.style.textAlign = "center";

            //게시글 수정
            cell = row.insertCell(7);
            cell.innerHTML = `<a href="/posts/edit/${post.post_id}">수정</a>`;
            cell.style.textAlign = "center";

            //게시글 삭제
            cell = row.insertCell(8);
            cell.innerHTML = `<a href="#" onclick="deletePost(${post.post_id})">삭제</a>`;
            cell.style.textAlign = "center";
        });
    });
</script>
</body>
</html>
